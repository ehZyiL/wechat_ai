<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>用户管理</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.11.3/font/bootstrap-icons.min.css">
    <style>
        body { background-color: #f8f9fa; }
        .table-hover tbody tr:hover { background-color: #e9ecef; }
        .avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
        .status-blocked { color: #dc3545; font-weight: bold; }
        .status-active { color: #198754; font-weight: bold; }
        .action-buttons .btn {
            margin-right: 5px;
        }
    </style>
</head>
<body>
<div class="container mt-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="bi bi-people-fill"></i> 用户管理</h1>
        <a href="/config" class="btn btn-secondary"><i class="bi bi-sliders"></i> 全局配置</a>
    </div>
    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead>
                    <tr>
                        <th>头像</th>
                        <th>昵称</th>
                        <th>用户ID (ExternalUserID)</th>
                        <th>状态</th>
                        <th class="text-center">操作</th>
                    </tr>
                    </thead>
                    <tbody id="user-table-body">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        loadUsers();
    });

    async function loadUsers() {
        try {
            const response = await fetch('/admin/api/users');
            if (response.status === 401) {
                window.location.href = '/admin/login'; // 未授权则跳转到登录页
                return;
            }
            if (!response.ok) {
                throw new Error('获取用户列表失败');
            }
            const users = await response.json();
            const tableBody = document.getElementById('user-table-body');
            tableBody.innerHTML = ''; // 清空现有内容

            if (users.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">暂无用户数据</td></tr>';
                return;
            }

            users.forEach(user => {
                const tr = document.createElement('tr');
                const statusClass = user.blocked ? 'status-blocked' : 'status-active';
                const statusText = user.blocked ? '已拉黑' : '正常';
                const blockButtonClass = user.blocked ? 'btn-success' : 'btn-danger';
                const blockButtonText = user.blocked ? '取消拉黑' : '拉黑';
                const blockButtonIcon = user.blocked ? 'bi-check-circle' : 'bi-slash-circle';
                const actionUrl = user.blocked ? `/admin/api/users/${user.externalUserId}/unblock` : `/admin/api/users/${user.externalUserId}/block`;

                // --- 【核心修改】在 tr.innerHTML 中增加了“文件管理”按钮 ---
                tr.innerHTML = `
                    <td><img src="${user.avatar || 'https://via.placeholder.com/40'}" alt="avatar" class="avatar"></td>
                    <td>${escapeHtml(user.nickname) || 'N/A'}</td>
                    <td><code>${escapeHtml(user.externalUserId)}</code></td>
                    <td><span class="${statusClass}">${statusText}</span></td>
                    <td class="text-center action-buttons">
                        <button class="btn ${blockButtonClass} btn-sm" onclick="toggleBlock('${actionUrl}')">
                            <i class="${blockButtonIcon}"></i> ${blockButtonText}
                        </button>
                        <a href="/config?externalUserId=${encodeURIComponent(user.externalUserId)}" class="btn btn-info btn-sm">
                            <i class="bi bi-gear-fill"></i> 配置
                        </a>
                        <a href="/files?externalUserId=${encodeURIComponent(user.externalUserId)}" class="btn btn-warning btn-sm">
                            <i class="bi bi-folder-symlink"></i> 文件管理
                        </a>
                    </td>
                `;
                // --- 修改结束 ---

                tableBody.appendChild(tr);
            });

        } catch (error) {
            console.error('Error:', error);
            const tableBody = document.getElementById('user-table-body');
            tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-danger">加载失败: ${error.message}</td></tr>`;
        }
    }

    async function toggleBlock(url) {
        if (!confirm('确定要执行此操作吗？')) {
            return;
        }
        try {
            const response = await fetch(url, { method: 'POST' });
            if (response.ok) {
                alert('操作成功！');
                loadUsers(); // 刷新列表
            } else {
                throw new Error('操作失败');
            }
        } catch(error) {
            console.error('Error:', error);
            alert(error.message);
        }
    }

    function escapeHtml(text) {
        if (!text) return '';
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return text.replace(/[&<>"']/g, function(m) { return map[m]; });
    }
</script>
</body>
</html>